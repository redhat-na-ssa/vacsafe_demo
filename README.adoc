= Vaccine Safe Demo

== Purpose

To provide a reproducible demo of a vaccination attestation application that uses Red Hat technologies.

=== Technical Discussion Vectors

== Deploy to OpenShift

== Demo Scenario

== Architecture

== Demo Components

== Local Containerized environment

This project includes a _docker-compose_ config file that allows for deployment of the application as containers in your local environment.

. Start application pod with all linux containers:
+
-----
$ docker-compose -f etc/docker-compose.yaml up -d
-----
+
NOTE:  If underlying linux container system in use in your local environment is podman, then follow this link:https://fedoramagazine.org/use-docker-compose-with-podman-to-orchestrate-containers-on-fedora/[set-up guide].

. Add DNS mappings to /etc/hosts for the following two services:  _vacsafe-service_ and _sso-service_
+
-----
$ cat /etc/hosts

127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 sso-service vacsafe-service
-----

. Stop application pod with all linux containers:
+
-----
$ docker-compose -f etc/docker-compose.yaml down
-----


== Test

=== Environment Variables

Set the following environment variables with values similar to the following:

. if testing locally deployed application (via docker-compose):
+
-----
RHSSO_URL=http://localhost:8080
REALM_ID=vacsafeRealm
retrieve_token_url="$RHSSO_URL/auth/realms/$REALM_ID/protocol/openid-connect/token"
VACSAFE_SERVICE_URL=http://localhost:9080
kjar_name=vacsafe-kjar
-----

. If testing environment deployed to OpenShift:
+
-----
RHSSO_URL=https://$(oc get route sso -n vacsafe-sso --template='{{ .spec.host }}')
REALM_ID=vacsafeRealm
retrieve_token_url="$RHSSO_URL/auth/realms/$REALM_ID/protocol/openid-connect/token"
VACSAFE_SERVICE_URL=https://$(oc get route vacsafe-service -n user1-vacsafe --template='{{ .spec.host }}')
kjar_name=vacsafe-kjar
-----

=== RH-SSO

. Log into _master_ realm of RH-SSO

.. If deployed in a local container environment, disable SSL requirement for master realm:
+
-----
$ podman exec -it etc_psql_sso_1 psql sso -c "update REALM set ssl_required='NONE' where id = 'master'"
-----

.. Log into _master_ realm of RH-SSO using credentials of  _master / master_ at the following URL:
+
-----
$ echo -en "\n$RHSSO_URL/auth/admin/master/console\n"
-----

. Login directly to the custom SSO realm used in the demo.  Details as follows:

.. *URL*
+
-----
$ echo -en "\n$RHSSO_URL/auth/admin/$REALM_ID/console\n"
-----

.. *userId* :  ssoRealmAdmin
.. *password* : pam


=== Vacsafe Service

The _vacsafe_service_ is enabled with an embedded RH-PAM _kieserver_ as well as various endpoints for managing documents.


. Retrieve an OAuth2 token using the `kie-server` SSO client of `vacsafeRealm`:
+
-----
TKN=$(curl -X POST "$retrieve_token_url" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "username=pamAdmin" \
            -d "password=pam" \
            -d "grant_type=password" \
            -d "client_id=kie-server" \
            | sed 's/.*access_token":"//g' | sed 's/".*//g')

echo $TKN

eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJOd010SUpfRnFuY3BMODJSQWRJMkMxSklLcXJWUzlBRWVNSHM0RktRZi1BIn0.eyJleHAiOjE2MTA3NjEzMzUsImlhdCI6MTYxMDc2MTAzNSwianRpIjoiOGM1YzJlZTAtMmZmZi00MGFhLTg0MGYtZWE2N2MxYWViNWZjIiwiaXNzIjoiaHR0cHM6Ly9rZXljbG9hay1yaC1zc28uYXBwcy5yaHRuY2twbWcucmhzbGVkb2NwLmNvbS9hdXRoL3JlYWxtcy9raWVSZWFsbSIsImF1ZCI6ImFjY291bnQiLCJzdWIiOiIzMmE4NjczNi04MThiLTRiM2MtODQyZi0zY2U4OGU3MjJkZGMiLCJ0eXAiOiJCZWFyZXIiLCJhenAiOiJraWUtc2VydmVyIiwic2Vzc2lvbl9zdGF0ZSI6Ijk0M2Y3NzRhLTgyOTItNDg1Mi04MmZkLWY2ZGNiMGU0NzQ0YiIsImFjciI6IjEiLCJhbGxvd2VkLW9yaWdpbnMiOlsiaHR0cHM6Ly9yaHBhbS1raWVzZXJ2ZXItcmhwYW0tZGV2LW9uY29yZS5hcHBzLnJodG5ja3BtZy5yaHNsZWRvY3AuY29tOjQ0MyIsImh0dHBzOi8vcmhwYW0ta2llc2VydmVyLXJocGFtLWRldi1vbmNvcmUuYXBwcy5yaHRuY2twbWcucmhzbGVkb2NwLmNvbSJdLCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsia2llbWdtdCIsImFkbWluIiwicmVzdC1hbGwiLCJBZG1pbmlzdHJhdG9ycyIsImtpZS1zZXJ2ZXIiLCJ1c2VyIl19LCJyZXNvdXJjZV9hY2Nlc3MiOnsiYWNjb3VudCI6eyJyb2xlcyI6WyJtYW5hZ2UtYWNjb3VudCIsIm1hbmFnZS1hY2NvdW50LWxpbmtzIiwidmlldy1wcm9maWxlIl19fSwic2NvcGUiOiJwcm9maWxlIGVtYWlsIiwiZW1haWxfdmVyaWZpZWQiOmZhbHNlLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJwYW1hZG1pbiIsImVtYWlsIjoicGFtYWRtaW5Ab3BlbnNoaWZ0Lm9wZW50bGMuY29tIn0.bmHT1R25G13c4CdYK2am-5-a-Y1QwRequsXg2C55fj7kdfBr8yJ7_qRrGQxQ4spy28f3O0vdtMc10O3h3HFTPZoCaGVqfciE4axcZI2zZLdVmc6qlmfLIj-hjZMqoOB-tAYyHcFoUN9mtQmJWhCaFO0JysCUpQHeOjssSizjjRHLW5Dsg5JHqZxR4iBuG-KBlfK-cI0ryeNQV5ljdP6nNn7UrEbhHP_rFyZlmHXgOAraL6MC75Rnra0nwIvg4Wu30WXppxT7HUlQj1lFBaZQUzmFXXJBXHBq_5ofNHgervMFtmyzlG_3r892e4JS1qZ7o4fDaXyMvD1RTa6WwKpC8g
-----

. By setting _fullScopeAllowed=true_ in SSO client, all roles assocated with an authenticated user will be included in the access token.
+
These roles can be visualized as follows:
+
-----
$ jq -R 'split(".") | .[1] | @base64d | fromjson' <<< $TKN | jq .realm_access.roles

[
  "interviewer",
  "kie-server",
  "user"
]
-----

. Using the OAuth2 token, invoke the kie-server to determine its current status:
+
-----
$ curl -v \
    -H "Authorization: Bearer $TKN" \
    -X GET \
    -H 'Accept:application/json' \
    $VACSAFE_SERVICE_URL/rest/server
-----

. Health Check Report
+
-----
$ curl -H "Authorization: Bearer $TKN" -H 'Accept:application/json' $VACSAFE_SERVICE_URL/rest/server/healthcheck?report=true
-----

. View swagger
+
-----
$ curl -v -H "Authorization: Bearer $TKN" $VACSAFE_SERVICE_URL/rest/swagger.json | jq .
-----

. View Swagger UI
+
Point your browser to the output of the following:
+
-----
$ echo -en "\n$VACSAFE_SERVICE_URL/rest/api-docs?url=$VACSAFE_SERVICE_URL/rest/swagger.json\n"
-----

. List KIE Containers
+
-----
$ curl -H "Authorization: Bearer $TKN" -X GET $VACSAFE_SERVICE_URL/rest/server/containers
-----

. List process definitions in JSON representation:
+
-----
$ curl -H "Authorization: Bearer $TKN" -X GET -H 'Accept:application/json' $VACSAFE_SERVICE_URL/rest/server/containers/$kjar_name/processes/
-----

. Start Test Result Submission Workflow
+
-----
$ curl -v -H "Authorization: Bearer $TKN" \
       -X POST \
       -H 'Content-Type:application/json' \
       $VACSAFE_SERVICE_URL/rest/server/containers/$kjar_name/processes/covid_test_result_submission_workflow/instances \
       -d @vacsafe-service/src/test/resources/testdata/CovidTestResultDocument_POSITIVE.json
-----


== Development

. Build and start vacsafe app :
+
-----
$ mvn clean package -DskipTests && \
         java \
           -Dorg.kie.server.repo=../etc/vacsafe-service/runtime_configs \
           -jar target/vacsafe-service-0.0.1.jar                                 &> /tmp/vacsafe-service.log & 
-----

. Unit Tests
+
-----
$ mvn clean test \
     -Daws.accessKeyId=$AWS_ACCESS_KEY_ID \
     -Daws.secretAccessKey=$AWS_SECRET_ACCESS_KEY
-----

-----
$ podman network create app

podman run -d -it --rm \
             --name psql-sso \
             --network=app \
             -p 4432:4432 \
             --mount 'type=bind,src=./etc/sso/db/sso-psql.conf,dst=/opt/app-root/src/postgresql-cfg/sso-psql.conf' \
             -e PGPORT=4432 -e POSTGRESQL_USER=sso -e POSTGRESQL_PASSWORD=sso -e POSTGRESQL_DATABASE=sso -e SCRIPT_DIR=/opt/sql \
             registry.redhat.io/rhel8/postgresql-12:1-72.1626836556 

podman run -d -it --rm \
           --name sso-service \
           --network=app \
           -p 127.0.0.1:8080:8080 \
           -p 127.0.0.1:8443:8443 \
           --mount 'type=bind,src=./etc/sso/vacsafe-realm.json,dst=/opt/vacsafe-realm.json' \
           -e SSO_POSTGRESQL_SERVICE_HOST=psql-sso -e SSO_POSTGRESQL_SERVICE_PORT=4432 -e DB_SERVICE_PREFIX_MAPPING="sso-postgresql=DB" -e DB_JNDI="java:jboss/datasources/KeycloakDS" \
           -e DB_USERNAME=sso -e DB_PASSWORD=sso -e DB_DATABASE=sso -e TX_DATABASE_PREFIX_MAPPING="sso-postgresql=DB" -e DB_MIN_POOL_SIZE=5 -e DB_MAX_POOL_SIZE=10 \
           -e SSO_ADMIN_USERNAME=master -e SSO_ADMIN_PASSWORD=master -e JAVA_OPTS_APPEND="-Dkeycloak.migration.strategy=IGNORE_EXISTING -Dkeycloak.import=/opt/vacsafe-realm.json" \
           registry.redhat.io/rh-sso-7/sso74-openshift-rhel8:7.4-36
        
podman run -d -it --rm \
             --name psql-vacsafe \
             --network=app \
             -p 6432:6432 \
             --mount 'type=bind,src=./etc/vacsafe-service/rhpam-psql.conf,dst=/opt/app-root/src/postgresql-cfg/rhpam-psql.conf' \
             --mount 'type=bind,src=./etc/vacsafe-service/ddl-scripts/postgresql/,dst=/opt/sql' \
             --mount 'type=bind,src=./etc/vacsafe-service/create_rhpam_database.sh,dst=/opt/app-root/src/postgresql-start/create_rhpam_database.sh' \
             -e PGPORT=6432 -e POSTGRESQL_USER=rhpam -e POSTGRESQL_PASSWORD=rhpam -e POSTGRESQL_DATABASE=rhpam -e POSTGRESQL_MAX_PREPARED_TRANSACTIONS=10 -e SCRIPT_DIR=/opt/sql \
             registry.redhat.io/rhel8/postgresql-12:1-72.1626836556 

-----


== Reference

== Bug List

== Operator Notes
